{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">Messages</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                <i data-feather="plus" class="feather-sm me-1"></i> New Message
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Message list -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Conversations</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active" id="all-messages-btn">All</button>
                    <button class="btn btn-sm btn-outline-secondary" id="unread-messages-btn">Unread</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush message-list">
                    <!-- Messages will be loaded here via JavaScript -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Message content -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="current-chat-name">Select a conversation</h5>
                <div>
                    <button class="btn btn-sm btn-outline-danger d-none" id="delete-conversation-btn">
                        <i data-feather="trash-2" class="feather-sm"></i>
                    </button>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="flex-grow-1 mb-3 message-container" id="message-container">
                    <!-- Initial state -->
                    <div class="text-center py-5" id="select-conversation-prompt">
                        <i data-feather="message-circle" class="feather-lg mb-3 text-secondary"></i>
                        <p class="text-secondary">Select a conversation from the list or start a new one.</p>
                    </div>
                    
                    <!-- Loading state (hidden initially) -->
                    <div class="text-center py-5 d-none" id="loading-messages">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading messages...</span>
                        </div>
                    </div>
                    
                    <!-- Messages will be displayed here -->
                    <div class="messages-list d-none" id="messages-list"></div>
                </div>
                
                <!-- Message input (hidden initially) -->
                <div class="message-input-container d-none" id="message-input-container">
                    <form id="message-form" class="d-flex">
                        <input type="text" class="form-control me-2" id="message-input" placeholder="Type your message here...">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="send" class="feather-sm"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newMessageModalLabel">New Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-message-form">
                    <div class="mb-3">
                        <label for="recipient" class="form-label">To:</label>
                        <select class="form-select" id="recipient" required>
                            <option value="" selected disabled>Select a recipient</option>
                            <!-- Recipients will be loaded here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="message-content" class="form-label">Message:</label>
                        <textarea class="form-control" id="message-content" rows="5" required></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load placeholder conversations (to be replaced with API calls)
        setTimeout(function() {
            const messageList = document.querySelector('.message-list');
            
            // Placeholder conversations
            const conversations = [
                { id: 1, name: 'Admin User', avatar: 'A', lastMessage: 'Welcome to the CRM Suite!', time: '10:30 AM', unread: true },
                { id: 2, name: 'John Smith', avatar: 'J', lastMessage: 'Let me know when you have time to discuss the new project.', time: 'Yesterday', unread: false },
                { id: 3, name: 'Sarah Johnson', avatar: 'S', lastMessage: 'The meeting is scheduled for tomorrow at 2 PM.', time: 'Yesterday', unread: false },
                { id: 4, name: 'Support Team', avatar: 'S', lastMessage: 'Your ticket has been resolved.', time: 'Mar 15', unread: false }
            ];
            
            // Render conversations
            messageList.innerHTML = '';
            conversations.forEach(conversation => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = `list-group-item list-group-item-action d-flex align-items-center p-3 ${conversation.unread ? 'unread-message' : ''}`;
                item.dataset.id = conversation.id;
                
                item.innerHTML = `
                    <div class="avatar d-inline-flex align-items-center justify-content-center bg-primary rounded-circle me-3" 
                         style="width: 40px; height: 40px; min-width: 40px;">
                        <span class="text-white fw-bold">${conversation.avatar}</span>
                    </div>
                    <div class="flex-grow-1 text-truncate">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 text-truncate">${conversation.name}</h6>
                            <small class="text-muted ms-2">${conversation.time}</small>
                        </div>
                        <p class="mb-0 text-truncate text-secondary">${conversation.lastMessage}</p>
                    </div>
                    ${conversation.unread ? '<span class="badge rounded-pill bg-primary ms-2">New</span>' : ''}
                `;
                
                messageList.appendChild(item);
                
                // Add click event listener
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Set all items as inactive
                    document.querySelectorAll('.message-list .list-group-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Set clicked item as active
                    this.classList.add('active');
                    
                    // Remove unread indicator
                    this.classList.remove('unread-message');
                    const badge = this.querySelector('.badge');
                    if (badge) badge.remove();
                    
                    // Show the conversation
                    showConversation(conversation);
                });
            });
            
            // Load recipients for new message modal
            const recipientSelect = document.getElementById('recipient');
            const users = [
                { id: 1, name: 'Admin User' },
                { id: 2, name: 'John Smith' },
                { id: 3, name: 'Sarah Johnson' },
                { id: 4, name: 'Support Team' }
            ];
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                recipientSelect.appendChild(option);
            });
            
            // Initialize feather icons for the newly added elements
            feather.replace();
        }, 1000);
        
        // Show conversation function
        function showConversation(conversation) {
            const selectPrompt = document.getElementById('select-conversation-prompt');
            const loadingMessages = document.getElementById('loading-messages');
            const messagesList = document.getElementById('messages-list');
            const inputContainer = document.getElementById('message-input-container');
            const currentChatName = document.getElementById('current-chat-name');
            const deleteBtn = document.getElementById('delete-conversation-btn');
            
            // Update header
            currentChatName.textContent = conversation.name;
            deleteBtn.classList.remove('d-none');
            
            // Show loading
            selectPrompt.classList.add('d-none');
            messagesList.classList.add('d-none');
            loadingMessages.classList.remove('d-none');
            
            // Simulate loading messages
            setTimeout(function() {
                loadingMessages.classList.add('d-none');
                messagesList.classList.remove('d-none');
                inputContainer.classList.remove('d-none');
                
                // Generate placeholder messages
                const messages = [
                    { sender: conversation.name, text: 'Hi there!', time: '10:15 AM', isMine: false },
                    { sender: 'You', text: 'Hello! How can I help you today?', time: '10:18 AM', isMine: true },
                    { sender: conversation.name, text: conversation.lastMessage, time: '10:30 AM', isMine: false }
                ];
                
                // Render messages
                messagesList.innerHTML = '';
                messages.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.isMine ? 'message-mine' : 'message-other'}`;
                    
                    messageEl.innerHTML = `
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${message.sender}</span>
                                <small class="message-time">${message.time}</small>
                            </div>
                            <div class="message-body">
                                ${message.text}
                            </div>
                        </div>
                    `;
                    
                    messagesList.appendChild(messageEl);
                });
                
                // Scroll to bottom
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 800);
        }
        
        // Handle message form submission
        const messageForm = document.getElementById('message-form');
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            // Create a new message
            const messagesList = document.getElementById('messages-list');
            const messageEl = document.createElement('div');
            messageEl.className = 'message message-mine';
            
            const now = new Date();
            const timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            messageEl.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">You</span>
                        <small class="message-time">${timeStr}</small>
                    </div>
                    <div class="message-body">
                        ${messageText}
                    </div>
                </div>
            `;
            
            messagesList.appendChild(messageEl);
            
            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messagesList.scrollTop = messagesList.scrollHeight;
        });
        
        // Handle new message form submission
        const newMessageForm = document.getElementById('new-message-form');
        newMessageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const recipientEl = document.getElementById('recipient');
            const subjectEl = document.getElementById('subject');
            const contentEl = document.getElementById('message-content');
            
            // Basic validation
            if (!recipientEl.value || !subjectEl.value || !contentEl.value.trim()) {
                return;
            }
            
            // In a real app, you would send this data to the server
            console.log('New message:', {
                recipient: recipientEl.value,
                subject: subjectEl.value,
                content: contentEl.value
            });
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
            modal.hide();
            
            // Reset form
            newMessageForm.reset();
            
            // Show success message
            alert('Message sent successfully!');
        });
        
        // Handle delete conversation button
        const deleteConversationBtn = document.getElementById('delete-conversation-btn');
        deleteConversationBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this conversation?')) {
                const activeItem = document.querySelector('.message-list .list-group-item.active');
                if (activeItem) {
                    activeItem.remove();
                }
                
                // Reset view
                document.getElementById('current-chat-name').textContent = 'Select a conversation';
                document.getElementById('select-conversation-prompt').classList.remove('d-none');
                document.getElementById('messages-list').classList.add('d-none');
                document.getElementById('message-input-container').classList.add('d-none');
                deleteConversationBtn.classList.add('d-none');
            }
        });
    });
</script>

<style>
    /* Additional message styling */
    .unread-message {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        font-weight: 500;
    }
    
    .message-container {
        overflow-y: auto;
        max-height: 500px;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
    }
    
    .message-mine {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }
    
    .message-mine .message-content {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--bs-light);
    }
    
    .message-other .message-content {
        background-color: rgba(var(--bs-secondary-rgb), 0.1);
        color: var(--bs-light);
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
    }
    
    .message-sender {
        font-weight: 600;
    }
    
    .message-time {
        color: var(--bs-secondary);
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .message-content {
            max-width: 90%;
        }
    }
</style>
{% endblock %}