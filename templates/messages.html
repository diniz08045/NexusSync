{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">Messages</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                <i data-feather="plus" class="feather-sm me-1"></i> New Message
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Message list -->
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Conversations</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active" id="all-messages-btn">All</button>
                    <button class="btn btn-sm btn-outline-secondary" id="unread-messages-btn">Unread</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush message-list">
                    {% for conversation in conversations %}
                    <a href="javascript:void(0)" onclick="selectConversation({{ loop.index0 }})" 
                       class="list-group-item list-group-item-action d-flex align-items-center p-3 {% if conversation.unread %}unread-message{% endif %}" 
                       data-id="{{ conversation.id }}">
                        <div class="avatar d-inline-flex align-items-center justify-content-center bg-primary rounded-circle me-3" 
                             style="width: 40px; height: 40px; min-width: 40px;">
                            <span class="text-white fw-bold">{{ conversation.avatar }}</span>
                        </div>
                        <div class="flex-grow-1 text-truncate">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-truncate">{{ conversation.name }}</h6>
                                <small class="text-muted ms-2">{{ conversation.time }}</small>
                            </div>
                            <p class="mb-0 text-truncate text-secondary">{{ conversation.last_message }}</p>
                        </div>
                        {% if conversation.unread %}
                        <span class="badge rounded-pill bg-primary ms-2 unread-badge">New</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Message content -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="current-chat-name">Select a conversation</h5>
                <div>
                    <button class="btn btn-sm btn-outline-danger d-none" id="delete-conversation-btn" onclick="deleteCurrentConversation()">
                        <i data-feather="trash-2" class="feather-sm"></i>
                    </button>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="flex-grow-1 mb-3 message-container" id="message-container">
                    <!-- Initial state -->
                    <div class="text-center py-5" id="select-conversation-prompt">
                        <i data-feather="message-circle" class="feather-lg mb-3 text-secondary"></i>
                        <p class="text-secondary">Select a conversation from the list or start a new one.</p>
                    </div>
                    
                    <!-- Loading state (hidden initially) -->
                    <div class="text-center py-5 d-none" id="loading-messages">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading messages...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading messages...</p>
                    </div>
                    
                    <!-- Messages will be displayed here -->
                    <div class="d-none" id="messages-list">
                        <!-- Placeholder for messages -->
                    </div>
                </div>
                
                <!-- Message input (hidden initially) -->
                <div class="message-input-container d-none" id="message-input-container">
                    <form id="message-form" class="d-flex" onsubmit="sendMessage(event)">
                        <input type="text" class="form-control me-2" id="message-input" placeholder="Type your message here...">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="send" class="feather-sm"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newMessageModalLabel">New Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="new-message-form" onsubmit="sendNewMessage(event)">
                    <div class="mb-3">
                        <label for="recipient" class="form-label">To:</label>
                        <select class="form-select" id="recipient" required>
                            <option value="" selected disabled>Select a recipient</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="message-content" class="form-label">Message:</label>
                        <textarea class="form-control" id="message-content" rows="5" required></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global state to store conversation data
    const conversationData = [
        {% for conversation in conversations %}
        {
            id: {{ conversation.id }},
            name: "{{ conversation.name }}",
            avatar: "{{ conversation.avatar }}",
            lastMessage: "{{ conversation.last_message }}",
            time: "{{ conversation.time }}",
            unread: {{ 'true' if conversation.unread else 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Initialize UI when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Set up filter buttons
        document.getElementById('all-messages-btn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('unread-messages-btn').classList.remove('active');
            // Show all conversations
            document.querySelectorAll('.message-list .list-group-item').forEach(function(item) {
                item.style.display = '';
            });
        });
        
        document.getElementById('unread-messages-btn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('all-messages-btn').classList.remove('active');
            // Show only unread conversations
            document.querySelectorAll('.message-list .list-group-item').forEach(function(item) {
                if (item.classList.contains('unread-message')) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Initialize delete button
        const deleteBtn = document.getElementById('delete-conversation-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', deleteCurrentConversation);
        }
    });
    
    // Handle selecting a conversation
    function selectConversation(index) {
        // Get conversation data
        const conversation = conversationData[index];
        if (!conversation) return;
        
        // Update UI to show this conversation is selected
        const conversationItems = document.querySelectorAll('.message-list .list-group-item');
        conversationItems.forEach(el => el.classList.remove('active'));
        
        // Mark the clicked conversation as active
        const selectedItem = conversationItems[index];
        if (selectedItem) {
            selectedItem.classList.add('active');
            
            // Remove unread indicator
            selectedItem.classList.remove('unread-message');
            const badge = selectedItem.querySelector('.unread-badge');
            if (badge) badge.remove();
        }
        
        // Show loading state
        document.getElementById('select-conversation-prompt').classList.add('d-none');
        document.getElementById('messages-list').classList.add('d-none');
        document.getElementById('loading-messages').classList.remove('d-none');
        
        // Update header with conversation name
        document.getElementById('current-chat-name').textContent = conversation.name;
        document.getElementById('delete-conversation-btn').classList.remove('d-none');
        
        // Display messages after a short delay (simulating API call)
        setTimeout(function() {
            displayMessages(conversation);
        }, 300);
    }
    
    // Display messages for a conversation
    function displayMessages(conversation) {
        // Hide loading screen
        document.getElementById('loading-messages').classList.add('d-none');
        
        // Show messages container
        const messagesList = document.getElementById('messages-list');
        messagesList.classList.remove('d-none');
        
        // Show input container
        document.getElementById('message-input-container').classList.remove('d-none');
        
        // Generate sample messages
        const messages = [
            { sender: conversation.name, text: 'Hi there!', time: '10:15 AM', isMine: false },
            { sender: 'You', text: 'Hello! How can I help you today?', time: '10:18 AM', isMine: true },
            { sender: conversation.name, text: conversation.lastMessage, time: '10:30 AM', isMine: false }
        ];
        
        // Clear previous messages
        messagesList.innerHTML = '';
        
        // Add messages to the UI
        messages.forEach(message => {
            addMessageToUI(message);
        });
        
        // Scroll to the bottom
        messagesList.scrollTop = messagesList.scrollHeight;
    }
    
    // Add a message to the UI
    function addMessageToUI(message) {
        const messagesList = document.getElementById('messages-list');
        
        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.isMine ? 'message-mine' : 'message-other'}`;
        
        // Set HTML content
        messageEl.innerHTML = `
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${message.sender}</span>
                    <small class="message-time">${message.time}</small>
                </div>
                <div class="message-body">
                    ${message.text}
                </div>
            </div>
        `;
        
        // Add to container
        messagesList.appendChild(messageEl);
    }
    
    // Send a message
    function sendMessage(event) {
        event.preventDefault();
        
        const input = document.getElementById('message-input');
        const messageText = input.value.trim();
        
        if (!messageText) return;
        
        // Create message data
        const now = new Date();
        const timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
        
        const message = {
            sender: 'You',
            text: messageText,
            time: timeStr,
            isMine: true
        };
        
        // Add to UI
        addMessageToUI(message);
        
        // Clear input
        input.value = '';
        
        // Scroll to bottom
        const messagesList = document.getElementById('messages-list');
        messagesList.scrollTop = messagesList.scrollHeight;
    }
    
    // Send a new message from the modal
    function sendNewMessage(event) {
        event.preventDefault();
        
        const recipientEl = document.getElementById('recipient');
        const subjectEl = document.getElementById('subject');
        const contentEl = document.getElementById('message-content');
        
        // Basic validation
        if (!recipientEl.value || !subjectEl.value || !contentEl.value.trim()) {
            return;
        }
        
        // Get the selected recipient option
        const selectedOption = recipientEl.options[recipientEl.selectedIndex];
        const recipientName = selectedOption.textContent;
        const recipientId = recipientEl.value;
        
        // Create a new conversation entry at the top of the list
        const messageList = document.querySelector('.message-list');
        const newConversationItem = document.createElement('a');
        
        // Generate first letter of recipient name as avatar
        const avatarLetter = recipientName.charAt(0);
        
        newConversationItem.className = 'list-group-item list-group-item-action d-flex align-items-center p-3';
        newConversationItem.href = 'javascript:void(0)';
        newConversationItem.dataset.id = recipientId;
        
        newConversationItem.innerHTML = `
            <div class="avatar d-inline-flex align-items-center justify-content-center bg-primary rounded-circle me-3" 
                 style="width: 40px; height: 40px; min-width: 40px;">
                <span class="text-white fw-bold">${avatarLetter}</span>
            </div>
            <div class="flex-grow-1 text-truncate">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0 text-truncate">${recipientName}</h6>
                    <small class="text-muted ms-2">Just now</small>
                </div>
                <p class="mb-0 text-truncate text-secondary">${subjectEl.value}</p>
            </div>
        `;
        
        // Add the new conversation to the data array
        const newConversation = {
            id: recipientId,
            name: recipientName,
            avatar: avatarLetter,
            lastMessage: subjectEl.value,
            time: 'Just now',
            unread: false
        };
        
        // Add to our data array
        conversationData.unshift(newConversation);
        
        // Prepend to the conversation list
        if (messageList.firstChild) {
            messageList.insertBefore(newConversationItem, messageList.firstChild);
        } else {
            messageList.appendChild(newConversationItem);
        }
        
        // Add click event to the new conversation
        newConversationItem.addEventListener('click', function() {
            selectConversation(0); // Will select the first item in our data array
        });
        
        // Show success message
        alert('Message sent successfully!');
        
        // Close modal
        const modalElement = document.getElementById('newMessageModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        
        // Reset form
        document.getElementById('new-message-form').reset();
        
        // Update the screen to show the new conversation
        selectConversation(0);
    }
    
    // Delete the current conversation
    function deleteCurrentConversation() {
        if (confirm('Are you sure you want to delete this conversation?')) {
            const activeItem = document.querySelector('.message-list .list-group-item.active');
            if (activeItem) {
                activeItem.remove();
            }
            
            // Reset view
            document.getElementById('current-chat-name').textContent = 'Select a conversation';
            document.getElementById('select-conversation-prompt').classList.remove('d-none');
            document.getElementById('messages-list').classList.add('d-none');
            document.getElementById('message-input-container').classList.add('d-none');
            document.getElementById('delete-conversation-btn').classList.add('d-none');
        }
    }
</script>

<style>
    /* Additional message styling */
    .unread-message {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        font-weight: 500;
    }
    
    .message-container {
        overflow-y: auto;
        max-height: 500px;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
    }
    
    .message-mine {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
    }
    
    .message-mine .message-content {
        background-color: rgba(var(--bs-primary-rgb), 0.25);
        color: var(--bs-light);
    }
    
    .message-other .message-content {
        background-color: rgba(var(--bs-secondary-rgb), 0.2);
        color: var(--bs-light);
    }
    
    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
    }
    
    .message-sender {
        font-weight: 600;
    }
    
    .message-time {
        color: var(--bs-secondary);
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .message-content {
            max-width: 90%;
        }
    }
</style>
{% endblock %}