{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Dashboard</h1>
            <div>
                <span class="text-secondary me-2">Today is</span>
                <span class="fw-bold text-primary">{{ now.strftime('%A, %d %B %Y') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card bg-gradient-primary text-white">
            <div class="stat-title">ACTIVE TASKS</div>
            <div class="stat-value" id="active-tasks-count">0</div>
            <div class="stat-change"><i data-feather="check-square" class="feather-sm"></i> Pending completion</div>
            <div class="stat-icon"><i data-feather="check-square"></i></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card bg-info text-white">
            <div class="stat-title">MEETINGS</div>
            <div class="stat-value" id="today-events-count">0</div>
            <div class="stat-change">Scheduled today</div>
            <div class="stat-icon"><i data-feather="calendar"></i></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card bg-success text-white">
            <div class="stat-title">NOTIFICATIONS</div>
            <div class="stat-value">{{ current_user.unread_notifications_count() }}</div>
            <div class="stat-change">Unread messages</div>
            <div class="stat-icon"><i data-feather="bell"></i></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stat-card bg-warning text-white">
            <div class="stat-title">SECURITY</div>
            <div class="stat-value">
                {% if current_user.two_factor_enabled %}
                <i data-feather="shield" class="feather-sm me-1"></i> ON
                {% else %}
                <i data-feather="shield-off" class="feather-sm me-1"></i> OFF
                {% endif %}
            </div>
            <div class="stat-change">Two-factor authentication</div>
            <div class="stat-icon"><i data-feather="lock"></i></div>
        </div>
    </div>
</div>

<!-- Task Management Row -->
<div class="row mb-4">
    <!-- To-Do List -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">To-Do List</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <i data-feather="plus" class="feather-sm"></i> Add Task
                </button>
            </div>
            <div class="card-body p-0">
                <div class="task-list">
                    <div class="task-list-filter p-3 border-bottom">
                        <div class="btn-group w-100">
                            <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="pending">Pending</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="completed">Completed</button>
                        </div>
                    </div>
                    <div class="task-list-container p-3" id="taskList">
                        <!-- Tasks will be loaded here via JavaScript -->
                        <div class="text-center py-5 task-empty-state">
                            <i data-feather="clipboard" class="feather-lg mb-2 text-secondary"></i>
                            <p class="text-secondary">No tasks yet. Add your first task!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Progress -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Current Progress</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <div>Completion Rate</div>
                        <div class="text-primary fw-medium" id="completion-percentage">0%</div>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" id="completion-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Task Categories</h6>
                    </div>
                    <div class="categories-container" id="categories-container">
                        <!-- Categories will be loaded here via JavaScript -->
                        <div class="text-center py-3 text-secondary">
                            No categories yet
                        </div>
                    </div>
                </div>
                
                <div class="priority-stats">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Task Priorities</h6>
                    </div>
                    <div class="row g-2" id="priority-stats">
                        <div class="col-4">
                            <div class="card bg-danger bg-opacity-10 p-2 text-center">
                                <div class="fw-bold text-danger fs-4" id="high-priority-count">0</div>
                                <div class="small">High</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-warning bg-opacity-10 p-2 text-center">
                                <div class="fw-bold text-warning fs-4" id="medium-priority-count">0</div>
                                <div class="small">Medium</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-success bg-opacity-10 p-2 text-center">
                                <div class="fw-bold text-success fs-4" id="low-priority-count">0</div>
                                <div class="small">Low</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upcoming Deadlines -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Upcoming Deadlines</h5>
                <button class="btn btn-sm btn-outline-primary" id="refresh-deadlines">
                    <i data-feather="refresh-cw" class="feather-sm"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="upcoming-deadlines" id="upcoming-deadlines">
                    <!-- Deadlines will be loaded here via JavaScript -->
                    <div class="text-center py-5 deadline-empty-state">
                        <i data-feather="calendar" class="feather-lg mb-2 text-secondary"></i>
                        <p class="text-secondary">No upcoming deadlines</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar and Schedule Row -->
<div class="row">
    <!-- Calendar -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Calendar</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                    <i data-feather="plus" class="feather-sm"></i> Add Event
                </button>
            </div>
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
    
    <!-- Event Scheduler -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Upcoming Events</h5>
            </div>
            <div class="card-body p-0">
                <div class="upcoming-events" id="upcoming-events">
                    <!-- Events will be loaded here via JavaScript -->
                    <div class="text-center py-5 event-empty-state">
                        <i data-feather="calendar" class="feather-lg mb-2 text-secondary"></i>
                        <p class="text-secondary">No upcoming events</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-end">
                    <div class="d-flex align-items-center ms-3">
                        <span class="badge-dot bg-primary me-2"></span>
                        <small>Meeting</small>
                    </div>
                    <div class="d-flex align-items-center ms-3">
                        <span class="badge-dot bg-success me-2"></span>
                        <small>Event</small>
                    </div>
                    <div class="d-flex align-items-center ms-3">
                        <span class="badge-dot bg-warning me-2"></span>
                        <small>Reminder</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskCategory" class="form-label">Category</label>
                            <select class="form-select" id="taskCategory">
                                <option value="Work">Work</option>
                                <option value="Personal">Personal</option>
                                <option value="Errands">Errands</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="taskPriority">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="taskDueDate" class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-control" id="taskDueDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">Add Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEventModalLabel">Add New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="eventType" class="form-label">Event Type</label>
                            <select class="form-select" id="eventType">
                                <option value="Meeting">Meeting</option>
                                <option value="Event">Event</option>
                                <option value="Reminder">Reminder</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="eventLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="eventLocation">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="eventStart" class="form-label">Start Date & Time</label>
                            <input type="datetime-local" class="form-control" id="eventStart" required>
                        </div>
                        <div class="col-md-6">
                            <label for="eventEnd" class="form-label">End Date & Time</label>
                            <input type="datetime-local" class="form-control" id="eventEnd" required>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="allDayEvent">
                        <label class="form-check-label" for="allDayEvent">All Day Event</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="notifyEvent">
                        <label class="form-check-label" for="notifyEvent">Send Notification</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Add Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailModalLabel">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="detailTaskTitle">Task Title</h4>
                <div class="d-flex mb-3">
                    <span class="badge task-priority me-2" id="detailTaskPriority">Medium</span>
                    <span class="badge bg-secondary me-2" id="detailTaskCategory">Work</span>
                    <span class="badge bg-secondary" id="detailTaskStatus">Pending</span>
                </div>
                <div class="mb-3">
                    <h6>Description</h6>
                    <p id="detailTaskDescription">Task description will appear here.</p>
                </div>
                <div class="mb-3">
                    <h6>Due Date</h6>
                    <p id="detailTaskDue">Due date will appear here.</p>
                </div>
                <div id="taskCompletionContainer" class="mb-3">
                    <h6>Completion</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="taskCompletionCheck">
                        <label class="form-check-label" for="taskCompletionCheck">
                            Mark as completed
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="deleteTaskBtn">
                    <i data-feather="trash" class="feather-sm"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editTaskBtn">Edit Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="detailEventTitle">Event Title</h4>
                <div class="d-flex mb-3">
                    <span class="badge bg-primary me-2" id="detailEventType">Meeting</span>
                </div>
                <div class="mb-3">
                    <h6>Description</h6>
                    <p id="detailEventDescription">Event description will appear here.</p>
                </div>
                <div class="mb-3">
                    <h6>Location</h6>
                    <p id="detailEventLocation">Event location will appear here.</p>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Start</h6>
                        <p id="detailEventStart">Start date and time</p>
                    </div>
                    <div class="col-md-6">
                        <h6>End</h6>
                        <p id="detailEventEnd">End date and time</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="deleteEventBtn">
                    <i data-feather="trash" class="feather-sm"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editEventBtn">Edit Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Store tasks and events in local storage
    let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
    let events = JSON.parse(localStorage.getItem('events') || '[]');
    let calendarInstance = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize FullCalendar
        initializeCalendar();
        
        // Initialize Tasks
        renderTasks();
        updateTaskStats();
        
        // Initialize Events
        renderEvents();
        
        // Fade in animations for the stats cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('fade-in');
            }, 100 * index);
        });
        
        // Add Task Form Submit Handler
        document.getElementById('saveTaskBtn').addEventListener('click', function() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const category = document.getElementById('taskCategory').value;
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            const task = {
                id: Date.now().toString(),
                title: title,
                description: description,
                category: category,
                priority: priority,
                dueDate: dueDate ? new Date(dueDate).toISOString() : null,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            // Add task to array
            tasks.push(task);
            
            // Save to local storage
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // Update UI
            renderTasks();
            updateTaskStats();
            
            // Reset form and close modal
            document.getElementById('addTaskForm').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            modal.hide();
        });
        
        // Task Detail Modal Handler
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('task-item') || e.target.closest('.task-item')) {
                const taskItem = e.target.classList.contains('task-item') ? e.target : e.target.closest('.task-item');
                const taskId = taskItem.dataset.id;
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    // Populate task detail modal
                    document.getElementById('detailTaskTitle').textContent = task.title;
                    document.getElementById('detailTaskPriority').textContent = task.priority;
                    document.getElementById('detailTaskPriority').className = `badge task-priority-${task.priority.toLowerCase()} me-2`;
                    document.getElementById('detailTaskCategory').textContent = task.category;
                    document.getElementById('detailTaskStatus').textContent = task.completed ? 'Completed' : 'Pending';
                    document.getElementById('detailTaskStatus').className = `badge ${task.completed ? 'bg-success' : 'bg-secondary'}`;
                    document.getElementById('detailTaskDescription').textContent = task.description || 'No description provided.';
                    document.getElementById('detailTaskDue').textContent = task.dueDate ? formatDateTime(new Date(task.dueDate)) : 'No due date';
                    
                    // Set completion checkbox
                    const completionCheck = document.getElementById('taskCompletionCheck');
                    completionCheck.checked = task.completed;
                    
                    // Set completion checkbox handler
                    completionCheck.onclick = function() {
                        toggleTaskCompletion(taskId);
                    };
                    
                    // Set delete button handler
                    document.getElementById('deleteTaskBtn').onclick = function() {
                        deleteTask(taskId);
                    };
                    
                    // Open the modal
                    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
                    modal.show();
                }
            }
        });
        
        // Add event handler
        document.getElementById('saveEventBtn').addEventListener('click', function() {
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const type = document.getElementById('eventType').value;
            const location = document.getElementById('eventLocation').value;
            const start = document.getElementById('eventStart').value;
            const end = document.getElementById('eventEnd').value;
            const allDay = document.getElementById('allDayEvent').checked;
            const notify = document.getElementById('notifyEvent').checked;
            
            if (!title || !start || !end) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Generate a color based on the event type
            let color;
            switch (type) {
                case 'Meeting':
                    color = '#0d6efd'; // primary
                    break;
                case 'Event':
                    color = '#198754'; // success
                    break;
                case 'Reminder':
                    color = '#ffc107'; // warning
                    break;
                default:
                    color = '#6c757d'; // secondary
            }
            
            const event = {
                id: Date.now().toString(),
                title: title,
                description: description,
                type: type,
                location: location,
                start: new Date(start).toISOString(),
                end: new Date(end).toISOString(),
                allDay: allDay,
                notify: notify,
                color: color,
                createdAt: new Date().toISOString()
            };
            
            // Add event to array
            events.push(event);
            
            // Save to local storage
            localStorage.setItem('events', JSON.stringify(events));
            
            // Update UI
            renderEvents();
            updateCalendar();
            
            // If notification is enabled and we have notification support
            if (notify && "Notification" in window) {
                // Schedule a notification for 15 minutes before the event
                const eventDate = new Date(start);
                const notificationDate = new Date(eventDate.getTime() - 15 * 60000); // 15 minutes before
                
                if (notificationDate > new Date()) {
                    const now = new Date();
                    const timeUntilNotification = notificationDate.getTime() - now.getTime();
                    
                    setTimeout(() => {
                        if (Notification.permission === "granted") {
                            new Notification(title, {
                                body: `Event starts in 15 minutes${location ? ` at ${location}` : ''}`,
                                icon: '/static/favicon.ico'
                            });
                        } else if (Notification.permission !== "denied") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    new Notification(title, {
                                        body: `Event starts in 15 minutes${location ? ` at ${location}` : ''}`,
                                        icon: '/static/favicon.ico'
                                    });
                                }
                            });
                        }
                    }, timeUntilNotification);
                }
            }
            
            // Reset form and close modal
            document.getElementById('addEventForm').reset();
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
            modal.hide();
        });
        
        // Task List Filter
        const filterButtons = document.querySelectorAll('.task-list-filter button');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                filterButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // Filter tasks
                const filter = this.dataset.filter;
                renderTasks(filter);
            });
        });
        
        // Fetch notifications for the sidebar
        fetch('/api/notifications?per_page=5')
            .then(response => response.json())
            .then(data => {
                // Handle notifications
            })
            .catch(error => {
                console.error('Error fetching notifications:', error);
            });
    });
    
    // Initialize FullCalendar
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        
        calendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: formatEventsForCalendar(),
            eventClick: function(info) {
                showEventDetails(info.event.id);
            },
            dateClick: function(info) {
                // Open add event modal with the date pre-filled
                const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
                
                // Set the date in the form
                const formattedDate = info.date.toISOString().slice(0, 16);
                document.getElementById('eventStart').value = formattedDate;
                
                // End date - add 1 hour
                const endDate = new Date(info.date);
                endDate.setHours(endDate.getHours() + 1);
                document.getElementById('eventEnd').value = endDate.toISOString().slice(0, 16);
                
                modal.show();
            }
        });
        
        calendarInstance.render();
    }
    
    // Format events for FullCalendar
    function formatEventsForCalendar() {
        return events.map(event => ({
            id: event.id,
            title: event.title,
            start: event.start,
            end: event.end,
            allDay: event.allDay,
            backgroundColor: event.color,
            borderColor: event.color
        }));
    }
    
    // Update Calendar
    function updateCalendar() {
        if (calendarInstance) {
            calendarInstance.removeAllEvents();
            calendarInstance.addEventSource(formatEventsForCalendar());
        }
    }
    
    // Render tasks in the task list
    function renderTasks(filter = 'all') {
        const taskList = document.getElementById('taskList');
        let filteredTasks;
        
        switch (filter) {
            case 'pending':
                filteredTasks = tasks.filter(task => !task.completed);
                break;
            case 'completed':
                filteredTasks = tasks.filter(task => task.completed);
                break;
            default:
                filteredTasks = tasks;
        }
        
        // Sort tasks by due date (null dates at the end)
        filteredTasks.sort((a, b) => {
            if (!a.dueDate && !b.dueDate) return 0;
            if (!a.dueDate) return 1;
            if (!b.dueDate) return -1;
            return new Date(a.dueDate) - new Date(b.dueDate);
        });
        
        // Update the task list
        if (filteredTasks.length === 0) {
            taskList.innerHTML = `
                <div class="text-center py-5 task-empty-state">
                    <i data-feather="clipboard" class="feather-lg mb-2 text-secondary"></i>
                    <p class="text-secondary">No tasks found.</p>
                </div>
            `;
        } else {
            taskList.innerHTML = '';
            
            filteredTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.dataset.id = task.id;
                
                // Determine if task is overdue
                let isOverdue = false;
                if (task.dueDate && !task.completed) {
                    const dueDate = new Date(task.dueDate);
                    const now = new Date();
                    isOverdue = dueDate < now;
                }
                
                taskItem.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input task-checkbox" type="checkbox" id="task-${task.id}" ${task.completed ? 'checked' : ''}>
                        <label class="form-check-label" for="task-${task.id}">
                            <div class="task-title">${task.title}</div>
                            <div class="task-details">
                                <span class="badge task-priority-${task.priority.toLowerCase()}">${task.priority}</span>
                                <span class="badge bg-secondary">${task.category}</span>
                                ${task.dueDate ? `<span class="task-due ${isOverdue ? 'overdue' : ''}">
                                    <i data-feather="clock" class="feather-xs"></i> 
                                    ${formatDate(new Date(task.dueDate))}
                                </span>` : ''}
                            </div>
                        </label>
                    </div>
                    <div class="task-actions">
                        ${!task.completed ? `<button class="btn btn-sm btn-link task-edit">
                            <i data-feather="edit" class="feather-sm"></i>
                        </button>` : ''}
                        <button class="btn btn-sm btn-link text-danger task-delete">
                            <i data-feather="trash-2" class="feather-sm"></i>
                        </button>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
            });
            
            // Initialize checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation(); // Prevent the click event from bubbling to the task-item
                    const taskId = this.closest('.task-item').dataset.id;
                    toggleTaskCompletion(taskId);
                });
            });
            
            // Initialize delete buttons
            document.querySelectorAll('.task-delete').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent the click event from bubbling to the task-item
                    const taskId = this.closest('.task-item').dataset.id;
                    deleteTask(taskId);
                });
            });
        }
        
        // Initialize feather icons
        feather.replace();
    }
    
    // Toggle task completion status
    function toggleTaskCompletion(taskId) {
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
            tasks[taskIndex].completed = !tasks[taskIndex].completed;
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            renderTasks(document.querySelector('.task-list-filter button.active').dataset.filter);
            updateTaskStats();
        }
    }
    
    // Delete a task
    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            tasks = tasks.filter(t => t.id !== taskId);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            renderTasks(document.querySelector('.task-list-filter button.active').dataset.filter);
            updateTaskStats();
            
            // Close the detail modal if it's open
            const modal = bootstrap.Modal.getInstance(document.getElementById('taskDetailModal'));
            if (modal) modal.hide();
        }
    }
    
    // Update task statistics
    function updateTaskStats() {
        // Update active tasks count
        const activeTasks = tasks.filter(t => !t.completed);
        document.getElementById('active-tasks-count').textContent = activeTasks.length;
        
        // Update completion percentage
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(t => t.completed).length;
        const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        document.getElementById('completion-percentage').textContent = `${completionPercentage}%`;
        document.getElementById('completion-progress').style.width = `${completionPercentage}%`;
        document.getElementById('completion-progress').setAttribute('aria-valuenow', completionPercentage);
        
        // Update priority counts
        const highPriorityCount = tasks.filter(t => t.priority === 'High' && !t.completed).length;
        const mediumPriorityCount = tasks.filter(t => t.priority === 'Medium' && !t.completed).length;
        const lowPriorityCount = tasks.filter(t => t.priority === 'Low' && !t.completed).length;
        
        document.getElementById('high-priority-count').textContent = highPriorityCount;
        document.getElementById('medium-priority-count').textContent = mediumPriorityCount;
        document.getElementById('low-priority-count').textContent = lowPriorityCount;
        
        // Update categories
        const categories = {};
        tasks.forEach(task => {
            if (!categories[task.category]) {
                categories[task.category] = {
                    total: 0,
                    completed: 0
                };
            }
            
            categories[task.category].total++;
            if (task.completed) {
                categories[task.category].completed++;
            }
        });
        
        const categoriesContainer = document.getElementById('categories-container');
        
        if (Object.keys(categories).length === 0) {
            categoriesContainer.innerHTML = `
                <div class="text-center py-3 text-secondary">
                    No categories yet
                </div>
            `;
        } else {
            categoriesContainer.innerHTML = '';
            
            Object.keys(categories).forEach(category => {
                const percentage = Math.round((categories[category].completed / categories[category].total) * 100);
                
                const categoryElement = document.createElement('div');
                categoryElement.className = 'mb-3';
                categoryElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>${category}</div>
                        <div class="text-secondary small">${categories[category].completed}/${categories[category].total}</div>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: ${percentage}%" 
                            aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            });
        }
        
        // Update upcoming deadlines
        const deadlinesContainer = document.getElementById('upcoming-deadlines');
        const upcomingTasks = tasks.filter(t => !t.completed && t.dueDate)
            .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
            .slice(0, 5);
        
        if (upcomingTasks.length === 0) {
            deadlinesContainer.innerHTML = `
                <div class="text-center py-5 deadline-empty-state">
                    <i data-feather="calendar" class="feather-lg mb-2 text-secondary"></i>
                    <p class="text-secondary">No upcoming deadlines</p>
                </div>
            `;
        } else {
            deadlinesContainer.innerHTML = '';
            
            upcomingTasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const isOverdue = dueDate < now;
                const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                
                const deadlineItem = document.createElement('div');
                deadlineItem.className = `deadline-item ${isOverdue ? 'overdue' : ''}`;
                deadlineItem.innerHTML = `
                    <div class="deadline-content">
                        <h6 class="deadline-title">${task.title}</h6>
                        <div class="deadline-details">
                            <span class="badge task-priority-${task.priority.toLowerCase()}">${task.priority}</span>
                            <span class="deadline-date">
                                <i data-feather="calendar" class="feather-xs"></i> ${formatDate(dueDate)}
                            </span>
                        </div>
                    </div>
                    <div class="deadline-status">
                        ${isOverdue 
                            ? '<span class="badge bg-danger">Overdue</span>' 
                            : daysLeft === 0 
                                ? '<span class="badge bg-warning">Today</span>' 
                                : daysLeft === 1 
                                    ? '<span class="badge bg-warning">Tomorrow</span>' 
                                    : `<span class="badge bg-info">${daysLeft} days left</span>`
                        }
                    </div>
                `;
                
                deadlinesContainer.appendChild(deadlineItem);
            });
        }
        
        // Initialize feather icons for the new elements
        feather.replace();
    }
    
    // Render events in the sidebar
    function renderEvents() {
        const eventsContainer = document.getElementById('upcoming-events');
        
        // Get today's events for the stats card
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const todayEvents = events.filter(event => {
            const eventDate = new Date(event.start);
            return eventDate >= today && eventDate < tomorrow;
        });
        
        document.getElementById('today-events-count').textContent = todayEvents.length;
        
        // Sort upcoming events by start date
        const upcomingEvents = events
            .filter(event => new Date(event.start) >= new Date())
            .sort((a, b) => new Date(a.start) - new Date(b.start))
            .slice(0, 5);
        
        if (upcomingEvents.length === 0) {
            eventsContainer.innerHTML = `
                <div class="text-center py-5 event-empty-state">
                    <i data-feather="calendar" class="feather-lg mb-2 text-secondary"></i>
                    <p class="text-secondary">No upcoming events</p>
                </div>
            `;
        } else {
            eventsContainer.innerHTML = '';
            
            upcomingEvents.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.dataset.id = event.id;
                
                const startDate = new Date(event.start);
                const now = new Date();
                const daysLeft = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                
                let dateDisplay;
                if (daysLeft === 0) {
                    dateDisplay = 'Today';
                } else if (daysLeft === 1) {
                    dateDisplay = 'Tomorrow';
                } else {
                    dateDisplay = formatDate(startDate);
                }
                
                eventItem.innerHTML = `
                    <div class="event-marker" style="background-color: ${event.color}"></div>
                    <div class="event-content">
                        <h6 class="event-title">${event.title}</h6>
                        <div class="event-details">
                            <span class="event-date">
                                <i data-feather="calendar" class="feather-xs"></i> ${dateDisplay}
                            </span>
                            <span class="event-time">
                                <i data-feather="clock" class="feather-xs"></i> ${formatTime(startDate)}
                            </span>
                            ${event.location ? `<span class="event-location">
                                <i data-feather="map-pin" class="feather-xs"></i> ${event.location}
                            </span>` : ''}
                        </div>
                    </div>
                `;
                
                eventsContainer.appendChild(eventItem);
                
                // Add click event
                eventItem.addEventListener('click', function() {
                    showEventDetails(event.id);
                });
            });
        }
        
        // Initialize feather icons
        feather.replace();
    }
    
    // Show event details
    function showEventDetails(eventId) {
        const event = events.find(e => e.id === eventId);
        
        if (event) {
            // Populate event detail modal
            document.getElementById('detailEventTitle').textContent = event.title;
            document.getElementById('detailEventType').textContent = event.type;
            document.getElementById('detailEventDescription').textContent = event.description || 'No description provided.';
            document.getElementById('detailEventLocation').textContent = event.location || 'No location specified.';
            document.getElementById('detailEventStart').textContent = formatDateTime(new Date(event.start));
            document.getElementById('detailEventEnd').textContent = formatDateTime(new Date(event.end));
            
            // Set delete button handler
            document.getElementById('deleteEventBtn').onclick = function() {
                deleteEvent(eventId);
            };
            
            // Open the modal
            const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
            modal.show();
        }
    }
    
    // Delete an event
    function deleteEvent(eventId) {
        if (confirm('Are you sure you want to delete this event?')) {
            events = events.filter(e => e.id !== eventId);
            localStorage.setItem('events', JSON.stringify(events));
            
            renderEvents();
            updateCalendar();
            
            // Close the detail modal if it's open
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailModal'));
            if (modal) modal.hide();
        }
    }
    
    // Utility function to format date
    function formatDate(date) {
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
    }
    
    // Utility function to format time
    function formatTime(date) {
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Utility function to format date and time
    function formatDateTime(date) {
        return `${formatDate(date)} at ${formatTime(date)}`;
    }
</script>

<style>
    /* Calendar Styling */
    #calendar {
        height: 500px;
    }
    
    /* Task Item Styling */
    .task-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem;
        border-bottom: 1px solid rgba(var(--bs-secondary-rgb), 0.1);
        transition: background-color 0.2s;
    }
    
    .task-item:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        cursor: pointer;
    }
    
    .task-item:last-child {
        border-bottom: none;
    }
    
    .task-item.completed .task-title {
        text-decoration: line-through;
        color: var(--bs-secondary);
    }
    
    .task-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .task-details {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    
    .task-due {
        color: var(--bs-secondary);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .task-due.overdue {
        color: var(--bs-danger);
        font-weight: 500;
    }
    
    .task-actions {
        display: flex;
        align-items: center;
    }
    
    /* Task Priority Badges */
    .task-priority-high {
        background-color: var(--bs-danger);
    }
    
    .task-priority-medium {
        background-color: var(--bs-warning);
    }
    
    .task-priority-low {
        background-color: var(--bs-success);
    }
    
    /* Deadline Item Styling */
    .deadline-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(var(--bs-secondary-rgb), 0.1);
    }
    
    .deadline-item:last-child {
        border-bottom: none;
    }
    
    .deadline-item.overdue {
        background-color: rgba(var(--bs-danger-rgb), 0.05);
    }
    
    .deadline-title {
        margin-bottom: 0.25rem;
    }
    
    .deadline-details {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
    }
    
    .deadline-date {
        color: var(--bs-secondary);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    /* Event Item Styling */
    .event-item {
        display: flex;
        padding: 1rem;
        border-bottom: 1px solid rgba(var(--bs-secondary-rgb), 0.1);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .event-item:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .event-item:last-child {
        border-bottom: none;
    }
    
    .event-marker {
        width: 4px;
        margin-right: 0.75rem;
        border-radius: 2px;
    }
    
    .event-title {
        margin-bottom: 0.25rem;
    }
    
    .event-details {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.75rem;
        color: var(--bs-secondary);
    }
    
    .event-date, .event-time, .event-location {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    /* Badge Dot for Legend */
    .badge-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    /* Responsive Calendar */
    @media (max-width: 767.98px) {
        #calendar {
            height: 400px;
        }
    }
</style>
{% endblock %}